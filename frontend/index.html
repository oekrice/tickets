<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title> Test page</title>
    <link rel="stylesheet" href="style.css">

</head>

<body>
    <div>Find train information between two stations. Input your requirements and if it's fine it'll print some things.</div>
    <hr>
    <div>
        <label for="origin-input">Origin Station: </label>
        <input  list="station-list" id="origin-input" placeholder = "Newcastle (NCL)"> 
        <datalist id="station-list">
    </div>
    <div>
        <label for="destination-input">Destination Station:</label>
        <input  list="station-list" id="destination-input"  placeholder = "York (YRK)"> 
    </div>
    <div>
        <label for="date-input">Date of Travel:</label>
        <!-- Need to obtain date bounds here. Not trivial-->        
        <input type="date" id="date-input">
    </div>
    <div>
        <label for="depart-time-input">Depart After:</label>
        <input type="time" id="depart-time-input">
    </div>
    <div>
        <label for="arrive-time-input">Arrive Before:</label>
        <input type="time" id="arrive-time-input">
    </div>

    <hr>
    <div>
        <button onclick=getTrains()>Get train data</button>
    <hr>
    <div id="status-container"></div>
    <div id="result-container"></div>
    <table id="outputTable" style="display:none">
        <tr>
            <th>Departs</th>
            <th>Arrives</th>
            <th>Price</th>
            <th>Journey Time</th>
        </tr>
    </table>

    </div>
</body>
<script>
    "use strict";
    let xhr = null;
    let originStation, destinationStation
    let trainDate, departTime, arriveTime
    let inputParameters
    let trainDataRaw, trainData
    let stationData
    //Update default parameters in the search bar (date etc.) and obtain the list of allowed stations
    getDefaults();

    async function getTrains() {
        //Send the parameters to Python and wait for a response...
        let requestStatus = 0
        let dataToSend = packageInputData(requestStatus);   //This also gives a message to the output lump. Currently unsure where we tell the output lump to get its thing but meh.
        let resultInfo 
        let parser, xmlDoc
        parser = new DOMParser()
        // console.log(dataToSend);
        if (!dataToSend) {
            console.log("Insufficient data entered. Aborting.");
            return;
        }

        try {
            // Send the POST request
            const response = await fetch("http://localhost:14752/trains", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json;charset=UTF-8"
                },
                body: JSON.stringify(dataToSend)
            });

            if (response.status === 201) {
                // console.log("Data creation response received!");
                trainDataRaw = await response.text();
                trainData = JSON.parse(trainDataRaw)  //Object containing the train outputs
                xmlDoc = parser.parseFromString(trainDataRaw,"text/xml")
                //At this point trigger a function to enable the HTML to make a nice table of the results
                makeResultTable(trainData)

                //If no results found, say as much and don't display the table
                if (trainData.length == 0) {
                    resultInfo = "No trains found."
                } else {
                    resultInfo = trainData.length.toString() + " trains found between " + String(originStation) + " and " + String(destinationStation) + ":"
                    document.getElementById("outputTable").style.display = "block";
                }
                document.getElementById("status-container").innerHTML = resultInfo;

                //document.getElementById('result-container').innerHTML = trainDataRaw;  //This is the bit which actually updates the result text, which is probably as a string. Would be better as an object...
            } else {
                console.error("Request failed with status:", response.status);
            }
        } catch (error) {
            console.error("Network error:", error);
        }
    }

    function toTime(rawTime){
        //Just a simple function to convert a raw time to a hh:mm etc.
        if (rawTime.length == 4) {
            return String(rawTime).substring(0,2) + ":" + String(rawTime).substring(2,4);
        } else {
            return "0" + String(rawTime).substring(0,1) + ":" + String(rawTime).substring(1,3);
        }
    }

    function toPrice(rawPrice){
        //Just a simple function to convert price to the correct format
        return "Â£" + rawPrice.toFixed(2);
    }

    function getDefaults(){

        //Get default parameters for the search fields (current time until midnight)
        let today = new Date();
        let fivemins = new Date()
        fivemins.setMinutes(fivemins.getMinutes() + 5)
        let todayString = today.toISOString().split('T')[0];
        let timeString = String(fivemins.getHours()).padStart(2,'0') + ":" + String(fivemins.getMinutes()).padStart(2,'0')
        document.getElementById('date-input').value = todayString;
        document.getElementById('date-input').min = todayString;
        //document.getElementById('depart-time-input').min = timeString;
        document.getElementById('depart-time-input').value = timeString;
        document.getElementById('arrive-time-input').value = "23:59";
        document.getElementById('arrive-time-input').min = timeString;

        //Add a bit which can get the list of stations (obtained from the dictionary file)
        async function loadStations() {
        const response = await fetch('./station_info.json');
        const data = await response.json();
        return data;
        }

        loadStations().then(stationData => {
            stationData;
            let stationTitle, fullTitle
            let options = ""
            //Populate the station data as soon as this is loaded? I think that might be what you're meant to do with these things... Async is a bit funny
            for (const key in stationData){
                stationTitle = stationData[key].station_name.substring(0,stationData[key].station_name.length-13) + " (" + key + ")"
                options +=  "<option value='" + stationTitle +"'>"
            }
            document.getElementById('station-list').innerHTML = options;
        })

    }

    function updateTimeBounds(){
        //If the arrive time changes etc., then make sure departure isn't after it. May be a tad tricky to get all the possibilities here...
        //If today then make sure depart time is greater than now, but not otherwise
        let today = new Date();
        let todayString = today.toISOString().split('T')[0];
        let timeString = today.getHours() + ":" + today.getMinutes()
        if (document.getElementById('date-input').value == todayString){
            document.getElementById('date-input').min = todayString;
        } else {
            document.getElementById('date-input').min = "00:00";
        }
    }

    function findJourneyTime(depTime, arrTime){
        //Using the departure and arrival time in the standard string format, output the journey time.
        let time1 = new Date();
        let time2 = new Date();
        let timeDiff = new Date();
        time1.setHours(depTime.substring(0,2));
        time1.setMinutes(depTime.substring(2,4));
        time2.setHours(arrTime.substring(0,2));
        time2.setMinutes(arrTime.substring(2,4));
        timeDiff = new Date(time2 - time1);
        return timeDiff;
    }

    function makeResultTable(trainData){
        //Uses the raw train Data and outputs in a nice table, which can be made pretty in due course
        //This is very ugly but hopefully won't be too slow...
        //Need to make sure that the table is made afresh each time.
        let outputTable = document.getElementById("outputTable");
        //Clear the existing results
        let rows = outputTable.rows;
        let i = rows.length;
        let newRow, newCell, newText;
        let depTime, arrTime;
        let journeyTime = new Date()

        while (--i) {
            outputTable.deleteRow(i)
        }
        for (let i = 0; i < trainData.length; i ++){
            newRow = outputTable.insertRow(-1);

            newCell = newRow.insertCell(0);
            newText = document.createTextNode(toTime(trainData[i].dep_time));           
            newCell.appendChild(newText);

            newCell = newRow.insertCell(1);
            newText = document.createTextNode(toTime(trainData[i].arr_time));
            newCell.appendChild(newText);
          
            newCell = newRow.insertCell(2);
            newText = document.createTextNode(toPrice(trainData[i].price));
            newCell.appendChild(newText);

            //Calculate the journey time here, as that's a useful thing to have
            journeyTime = findJourneyTime(trainData[i].dep_time, trainData[i].arr_time)
            newCell = newRow.insertCell(3);
            if (journeyTime.getUTCHours() < 1){
                newText = document.createTextNode(journeyTime.getUTCMinutes() + "m");
            } else {
                newText = document.createTextNode(journeyTime.getUTCHours() + "h" + journeyTime.getUTCMinutes());
            }
            newCell.appendChild(newText);
        }
    }

    function packageInputData(requestStatus){
        let departMinutes, arriveMinutes
        //This is for taking the input data, checking if it exists and compiling into a 'dictionary' for jsonifying. Not sure what the correct approach here is but I think it's the same as python...
        originStation = document.getElementById('origin-input').value;
        originStation = String(originStation).substring(originStation.length-4,originStation.length-1)
        if (!originStation) {
            originStation = "NCL"
            // console.log("No origin station.");
            // document.getElementById("status-container").innerHTML = "Please input an origin station and try again.";
            // document.getElementById("result-container").innerHTML = "";
            // document.getElementById("outputTable").style.display = "none";
            // return;
        }

        destinationStation = document.getElementById('destination-input').value;
        destinationStation = String(destinationStation).substring(destinationStation.length-4,destinationStation.length-1)
        if (!destinationStation) {
            destinationStation = "YRK"
            // console.log("No destination station.");
            // document.getElementById("status-container").innerHTML = "Please input a destination station and try again.";
            // document.getElementById("result-container").innerHTML = "";
            // document.getElementById("outputTable").style.display = "none";
            // return;
        }

        trainDate = document.getElementById('date-input').value;
        departTime = document.getElementById('depart-time-input').value;
        arriveTime = document.getElementById('arrive-time-input').value;
        
        //Do some checks on the valid times. Need converting to a date for that.
        departMinutes = departTime.substring(0,2) + departTime.substring(3,5)
        if (departTime.substring(0,2) + departTime.substring(3,5) > arriveTime.substring(0,2) + arriveTime.substring(3,5)){
            console.log("Departs after arrives");
            document.getElementById("status-container").innerHTML = "Arrival time must be after departure time.";
            document.getElementById("result-container").innerHTML = "";
            document.getElementById("outputTable").style.display = "none";
            return;
        }

        //If the input is today, check that the departure time isn't earlier than now
        let today = new Date();
        let todayString = today.toISOString().split('T')[0];
        let timeString = String(today.getHours()).padStart(2,'0') + ":" + String(today.getMinutes()).padStart(2,'0')
        if (document.getElementById('date-input').value == todayString){
            if (timeString.substring(0,2) + timeString.substring(3,5) > departTime.substring(0,2) + departTime.substring(3,5)){
                console.log("Departs in the past");
                document.getElementById("status-container").innerHTML = "Departure time must not be in the past.";
                document.getElementById("result-container").innerHTML = "";
                document.getElementById("outputTable").style.display = "none";
                return
            }
        }
        //If this is the first request (status == 0) then print as much. If not keep the current results. Not sure what I meant by that now.
        if (requestStatus == 0){
            document.getElementById("status-container").innerHTML = "Potentially valid request submitted... Hopefully the backend is doing something now.";
            document.getElementById("result-container").innerHTML = "";
            document.getElementById("outputTable").style.display = "none";
        } else {
            document.getElementById("status-container").innerHTML = "Finding more tickets (may take a while...)";
        }
        
        //If it's got this far, there are at least origin and destination stations
        inputParameters = {"requestStatus":requestStatus, "origin":originStation, "destination":destinationStation, "date":trainDate, "departTime": departTime, "arriveTime": arriveTime};
        console.log(inputParameters)
        return inputParameters;
    }

</script>
</html>
