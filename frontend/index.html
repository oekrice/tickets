<html>
<header>
    <title> Test page</title>
</header>

<body>
    <div>Find train information between two stations. Input the data below and if it's fine it'll print some things.</div>
    <hr>
    <div>
        <label for="origin-input">Origin Station Code:</label>
        <input type="text" id="origin-input", value = "NCL">
        <!-- <button onclick="sendData()">Send data</button> -->
    </div>
    <div>
        <label for="destination-input">Destination Station Code:</label>
        <input type="text" id="destination-input", value = "YRK">
        <!-- <button onclick="sendData()">Send data</button> -->
    </div>
    
    <hr>
    <div>
        <button onclick="getTrains()">Get train data for today</button>
    <hr>
    <div id="status-container"></div>
    <div id="result-container"></div>
    </div>
</body>
<script>
   let raw_response
   let xhr = null;
    getXmlHttpRequestObject = function () {
        if (!xhr) {
            // Create a new XMLHttpRequest object 
            xhr = new XMLHttpRequest();
        }
        return xhr;
    }; 

    async function getTrains() {
        //Send the parameters to Python and wait for a response...
        let dataToSend = packageInputData();   //This also gives a message to the output lump. Currently unsure where we tell the output lump to get its thing but meh.
        console.log(dataToSend);
        if (!dataToSend) {
            console.log("Insufficient data entered. Aborting.");
            return;
        }

        try {
            // Send the POST request
            const response = await fetch("http://localhost:14752/trains", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json;charset=UTF-8"
                },
                body: JSON.stringify(dataToSend)
            });

            if (response.status === 201) {
                console.log("Data creation response received!");
                const text = await response.text();
                document.getElementById('status-container').innerHTML = "Results found:";  //This is the bit which actually updates the result text, which is probably as a string. Would be better as an object...
                document.getElementById('result-container').innerHTML = text;  //This is the bit which actually updates the result text, which is probably as a string. Would be better as an object...
            } else {
                console.error("Request failed with status:", response.status);
            }
        } catch (error) {
            console.error("Network error:", error);
        }
    }

    function packageInputData(){
        //This is for taking the input data, checking if it exists and compiling into a 'dictionary' for jsonifying. Not sure what the correct approach here is but I think it's the same as python...
        originStation = document.getElementById('origin-input').value;
        if (!originStation) {
            console.log("No origin station.");
            document.getElementById("status-container").innerHTML = "Please input an origin station and try again.";
            return;
        }
        destinationStation = document.getElementById('destination-input').value;
        if (!destinationStation) {
            console.log("No destination station.");
            document.getElementById("status-container").innerHTML = "Please input a destination station and try again.";
            return;
        }
        document.getElementById("status-container").innerHTML = "Potentially valid request submitted... Hopefully the backend is doing something now.";
        //If it's got this far, there are at least origin and destination stations
        inputParameters = {"origin":originStation, "destination":destinationStation};
        return inputParameters;
    }

</script>
</html>
